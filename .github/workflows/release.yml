name: Create Release

on:
    push:
        branches:
            - main
            - master

jobs:
    check-version:
        runs-on: ubuntu-latest
        outputs:
            should_release: ${{ steps.check.outputs.should_release }}
            version: ${{ steps.extract.outputs.version }}
        steps:
            - name: Check commit message
              id: check
              run: |
                  COMMIT_MSG="${{ github.event.head_commit.message }}"
                  if [[ "$COMMIT_MSG" =~ nVersion$ ]]; then
                    echo "should_release=true" >> $GITHUB_OUTPUT
                  else
                    echo "should_release=false" >> $GITHUB_OUTPUT
                  fi

            - name: Extract version
              id: extract
              if: steps.check.outputs.should_release == 'true'
              run: |
                  COMMIT_MSG="${{ github.event.head_commit.message }}"
                  # Extract version number (looks for vX.Y.Z or X.Y.Z pattern)
                  VERSION=$(echo "$COMMIT_MSG" | grep -oP 'v?\d+\.\d+\.\d+' | head -1)
                  if [ -z "$VERSION" ]; then
                    # If no version found, use timestamp
                    VERSION="v$(date +%Y.%m.%d-%H%M%S)"
                  fi
                  # Ensure version starts with 'v'
                  [[ "$VERSION" =~ ^v ]] || VERSION="v$VERSION"
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Extracted version: $VERSION"

    build:
        needs: check-version
        if: needs.check-version.outputs.should_release == 'true'
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                include:
                    - os: ubuntu-latest
                      platform: linux
                      artifact_name: moneycalculator-linux.jar
                    - os: windows-latest
                      platform: windows
                      artifact_name: moneycalculator-windows.jar
                    - os: macos-latest
                      platform: macos
                      artifact_name: moneycalculator-macos.jar

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch all history for release notes

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"
                  cache: maven

            - name: Build with Maven
              run: mvn clean package -DskipTests

            - name: Rename artifact
              shell: bash
              run: |
                  mkdir -p artifacts
                  cp target/moneycalculator-*-jar-with-dependencies.jar artifacts/${{ matrix.artifact_name }}

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.platform }}-build
                  path: artifacts/${{ matrix.artifact_name }}

    create-release:
        needs: [check-version, build]
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: release-artifacts

            - name: Generate release notes
              id: release_notes
              run: |
                  # Get the latest tag
                  LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

                  if [ -z "$LATEST_TAG" ]; then
                    echo "## ðŸŽ‰ Initial Release" > RELEASE_NOTES.md
                    echo "" >> RELEASE_NOTES.md
                    echo "This is the first release of Money Calculator!" >> RELEASE_NOTES.md
                    echo "" >> RELEASE_NOTES.md
                    echo "### ðŸ“ All Commits" >> RELEASE_NOTES.md
                    git log --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
                  else
                    echo "## ðŸš€ What's Changed" > RELEASE_NOTES.md
                    echo "" >> RELEASE_NOTES.md
                    echo "### ðŸ“ Commits since $LATEST_TAG" >> RELEASE_NOTES.md
                    git log $LATEST_TAG..HEAD --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
                  fi

                  echo "" >> RELEASE_NOTES.md
                  echo "" >> RELEASE_NOTES.md
                  echo "## ðŸ“¦ Assets" >> RELEASE_NOTES.md
                  echo "" >> RELEASE_NOTES.md
                  echo "Download the JAR file for your platform:" >> RELEASE_NOTES.md
                  echo "- **Linux**: \`moneycalculator-linux.jar\`" >> RELEASE_NOTES.md
                  echo "- **Windows**: \`moneycalculator-windows.jar\`" >> RELEASE_NOTES.md
                  echo "- **macOS**: \`moneycalculator-macos.jar\`" >> RELEASE_NOTES.md
                  echo "" >> RELEASE_NOTES.md
                  echo "### ðŸš€ How to Run" >> RELEASE_NOTES.md
                  echo "\`\`\`bash" >> RELEASE_NOTES.md
                  echo "java -jar moneycalculator-<platform>.jar" >> RELEASE_NOTES.md
                  echo "\`\`\`" >> RELEASE_NOTES.md

                  cat RELEASE_NOTES.md

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ needs.check-version.outputs.version }}
                  name: Release ${{ needs.check-version.outputs.version }}
                  body_path: RELEASE_NOTES.md
                  draft: false
                  prerelease: false
                  files: |
                      release-artifacts/linux-build/moneycalculator-linux.jar
                      release-artifacts/windows-build/moneycalculator-windows.jar
                      release-artifacts/macos-build/moneycalculator-macos.jar
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
